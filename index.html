<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>เข้าร่วมเกม Q-ARE Code Breaker</title>
<style>
  body{
    margin:0;font-family:sans-serif;
    background:linear-gradient(135deg,#6d28d9,#7c3aed);
    height:100vh;display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    color:#fff;text-align:center;
  }
  h1{font-size:48px;margin-bottom:24px;font-weight:900}
  form{
    background:#fff;color:#111;padding:24px 28px;
    border-radius:16px;box-shadow:0 6px 30px rgba(0,0,0,.25)
  }
  input{
    display:block;
    width:260px;
    margin:10px auto;
    padding:14px 16px;
    font-size:22px;
    font-weight:700;
    border-radius:8px;
    border:1px solid #ccc;
    text-align:center;
  }
  button{
    margin-top:12px;padding:10px 20px;
    font-size:18px;border:none;border-radius:8px;
    background:#111;color:#fff;cursor:pointer;font-weight:700
  }
  button:hover{background:#000}
</style>
</head>
<body>
  <h1>QR Breaker</h1>
  <form id="joinForm">
    <input type="text" id="pinInput" placeholder="รหัส PIN เกม" required>
    <input type="text" id="nameInput" placeholder="ชื่อผู้เล่น" required maxlength="10">
    <button type="submit">เข้าสู่เกม</button>
    <div id="msg" style="margin-top:10px;color:#000000"></div>
  </form>

<script type="module">
import { supabase } from "./supabase.js";

const form = document.getElementById("joinForm");
const msg = document.getElementById("msg");

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const pin = document.getElementById("pinInput").value.trim();
  const name = document.getElementById("nameInput").value.trim();

  if(!pin || !name){
    msg.textContent = "⚠️ กรุณากรอกรหัส PIN และชื่อผู้เล่น";
    return;
  }

  msg.textContent = "⏳ กำลังตรวจสอบรหัส...";

  // ✅ ตรวจว่าห้องนี้มีอยู่จริง
  const { data: game, error: gameErr } = await supabase
    .from("games")
    .select("*")
    .eq("pin", pin)
    .order("created_at", { ascending: false })
    .limit(1)
    .single();

  if (gameErr || !game) {
    msg.textContent = "❌ รหัสนี้ไม่ถูกต้อง หรือห้องนี้ถูกปิดแล้ว";
    return;
  }

  // ✅ ตรวจว่าชื่อซ้ำในห้องนี้ไหม
  const { data: existingPlayers, error: dupErr } = await supabase
    .from("players")
    .select("name")
    .eq("pin", pin)
    .ilike("name", name); // ตรวจแบบไม่สนตัวพิมพ์ใหญ่เล็ก

  if (dupErr) {
    console.error(dupErr);
    msg.textContent = "⚠️ เกิดข้อผิดพลาดระหว่างตรวจสอบชื่อ";
    return;
  }

  if (existingPlayers.length > 0) {
    msg.textContent = "⚠️ ชื่อซ้ำในห้องนี้ กรุณาใช้ชื่ออื่น";
    return;
  }

  // ✅ ถ้าไม่ซ้ำ → เพิ่มผู้เล่นใหม่
  const { data: player, error: insertErr } = await supabase
    .from("players")
    .insert([{ name, pin, score: 0 }])
    .select()
    .single();

  if (insertErr) {
    msg.textContent = "❌ เข้าร่วมห้องไม่สำเร็จ ลองใหม่อีกครั้ง";
    console.error(insertErr);
    return;
  }

  // ✅ บันทึกข้อมูลลง localStorage
  localStorage.setItem("player_id", player.id);
  localStorage.setItem("player_name", player.name);
  localStorage.setItem("player_pin", pin);

  msg.textContent = "✅ เข้าห้องสำเร็จ! กำลังเข้าสู่เกม...";
  setTimeout(() => window.location.href = `/game.html?pin=${pin}`, 500);
});
</script>
</body>
</html>
